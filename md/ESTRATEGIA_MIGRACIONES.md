# Estrategia de Migraciones: Desarrollo vs ProducciÃ³n

## ğŸ¤” Pregunta Original

> "Actualmente dicho proyecto estÃ¡ en mi pc lo subirÃ© a git y se descargarÃ¡ en la pc del banco y necesito hacer una instalacion limpia de la api y las migraciones para su primera creacion en los servidores del banco. Â¿Se que debo cambiar las cadenas de conexion pero no puedo ir con estas migraciones actuales ya que han sufrido cambios o es recomendable?"

## âœ… Respuesta: NO uses las migraciones actuales

**Tienes razÃ³n** en tu preocupaciÃ³n. Las migraciones actuales tienen historial de cambios y NO son apropiadas para una instalaciÃ³n limpia en producciÃ³n.

---

## ğŸ“‹ El Problema

### Migraciones Actuales (Desarrollo)

```
PostgreSql/
â”œâ”€â”€ 20260124033920_InitialCreate.cs
â””â”€â”€ 20260127235613_RemovePostgreSqlForeignKeys.cs  â† Cambio despuÃ©s de la inicial
```

**Problema**:
- La primera migraciÃ³n crea tablas CON foreign keys
- La segunda migraciÃ³n ELIMINA foreign keys
- En producciÃ³n, esto es innecesario y confuso

### Lo que Necesitas en ProducciÃ³n

```
PostgreSql/
â””â”€â”€ InitialProductionCreate.cs  â† Estado FINAL limpio (sin FKs desde el inicio)
```

**Ventajas**:
- Una sola migraciÃ³n con el estado correcto final
- Sin historial de cambios intermedios
- MÃ¡s simple de mantener
- MÃ¡s rÃ¡pida de aplicar

---

## ğŸ¯ Estrategia Recomendada: Dual Track

### Track 1: Desarrollo (Tu PC)

**Estado Actual**: Mantener como estÃ¡
```
âœ… Migraciones aplicadas y funcionando
âœ… Base de datos en estado correcto
âœ… NO tocar nada
```

**AcciÃ³n**: NINGUNA - tu entorno de desarrollo sigue funcionando

### Track 2: ProducciÃ³n (Banco)

**Estado Objetivo**: InstalaciÃ³n limpia desde cero
```
âœ… Migraciones limpias sin historial
âœ… Scripts SQL revisados
âœ… Estado final correcto desde el inicio
```

**AcciÃ³n**: Generar migraciones limpias para producciÃ³n

---

## ğŸ”§ CÃ³mo Implementarlo

### Paso 1: Mantener Migraciones de Desarrollo

**NO hagas nada en tu PC**. Tus migraciones actuales funcionan correctamente:

```bash
# Tu PC (desarrollo) - NO TOCAR
src/FastServer.Infrastructure/Data/Migrations/
â”œâ”€â”€ PostgreSql/
â”‚   â”œâ”€â”€ 20260124033920_InitialCreate.cs
â”‚   â”œâ”€â”€ 20260127235613_RemovePostgreSqlForeignKeys.cs
â”‚   â””â”€â”€ PostgreSqlDbContextModelSnapshot.cs  â† Estado final correcto
â””â”€â”€ SqlServer/
    â”œâ”€â”€ 20260123201324_InitialMigration.cs
    â”œâ”€â”€ 20260127035345_InitialMicroservicesSchema.cs
    â””â”€â”€ SqlServerDbContextModelSnapshot.cs
```

### Paso 2: Generar Migraciones Limpias para ProducciÃ³n

**Antes del deployment al banco**, ejecutar:

#### OpciÃ³n A: Usando PowerShell (Windows)

```powershell
# Desde la raÃ­z del proyecto
.\scripts\generate-production-migrations.ps1 -Both
```

#### OpciÃ³n B: Usando Bash (Linux/Mac)

```bash
# Desde la raÃ­z del proyecto
chmod +x scripts/generate-production-migrations.sh
./scripts/generate-production-migrations.sh --both
```

#### OpciÃ³n C: Manual (si los scripts no funcionan)

```bash
cd src/FastServer.Infrastructure

# Backup de migraciones actuales
mkdir -p ../../scripts/backup-migrations
cp -r Data/Migrations ../../scripts/backup-migrations/

# Eliminar migraciones antiguas (excepto snapshot)
find Data/Migrations/PostgreSql -name "*.cs" ! -name "*Snapshot.cs" -delete

# Generar migraciÃ³n limpia PostgreSQL
dotnet ef migrations add InitialProductionCreate \
  --context PostgreSqlDbContext \
  --output-dir Data/Migrations/PostgreSql \
  --project FastServer.Infrastructure.csproj \
  --startup-project ../FastServer.GraphQL.Api/FastServer.GraphQL.Api.csproj

# Generar script SQL
cd ../FastServer.GraphQL.Api
dotnet ef migrations script \
  --context PostgreSqlDbContext \
  --idempotent \
  --output ../../scripts/production-migrations/postgresql-initial.sql
```

### Paso 3: Verificar Scripts Generados

**IMPORTANTE**: Antes de aplicar en producciÃ³n, revisar:

```bash
cat scripts/production-migrations/postgresql-initial.sql
```

**Verificar que el script**:
- âœ… Crea todas las tablas necesarias
- âœ… Crea Ã­ndices
- âœ… NO crea foreign keys en PostgreSQL
- âœ… Usa IF NOT EXISTS (idempotente)

**Ejemplo de lo que DEBES ver**:

```sql
CREATE TABLE IF NOT EXISTS "FastServer_LogServices_Header" (
    fastserver_log_id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    fastserver_log_date_in timestamp with time zone NOT NULL,
    -- ... mÃ¡s columnas
    CONSTRAINT "PK_FastServer_LogServices_Header" PRIMARY KEY (fastserver_log_id)
);

-- Ãndices
CREATE INDEX IF NOT EXISTS "IX_FastServer_LogServices_Header_fastserver_log_date_in"
    ON "FastServer_LogServices_Header" (fastserver_log_date_in);

-- NO debe haber ALTER TABLE ... ADD CONSTRAINT ... FOREIGN KEY
```

### Paso 4: Aplicar en ProducciÃ³n (Banco)

#### OpciÃ³n A: Usando Scripts SQL (RECOMENDADO)

```bash
# En el servidor del banco
psql -h servidor-postgres -U usuario -d FastServerLogs \
  -f scripts/production-migrations/postgresql-initial.sql
```

**Ventajas**:
- DBA puede revisar el script antes de ejecutar
- Puede ejecutarse en mantenimiento programado
- Auditable

#### OpciÃ³n B: Usando dotnet ef (Durante instalaciÃ³n)

```bash
# En el servidor del banco, durante la instalaciÃ³n
cd src/FastServer.GraphQL.Api
dotnet ef database update --context PostgreSqlDbContext
```

**Ventajas**:
- MÃ¡s rÃ¡pido durante instalaciÃ³n inicial
- AutomÃ¡tico

---

## ğŸ“Š ComparaciÃ³n Visual

### âŒ Aplicar Migraciones de Desarrollo (MAL)

```
ProducciÃ³n (Banco):
1. InitialCreate â†’ Crea tablas CON FKs
2. RemovePostgreSqlForeignKeys â†’ Elimina FKs
   âš ï¸ Dos pasos innecesarios
   âš ï¸ Historial confuso
   âš ï¸ MÃ¡s lento
```

### âœ… Aplicar MigraciÃ³n Limpia (BIEN)

```
ProducciÃ³n (Banco):
1. InitialProductionCreate â†’ Crea tablas SIN FKs directamente
   âœ… Un solo paso
   âœ… Estado correcto desde el inicio
   âœ… MÃ¡s rÃ¡pido
   âœ… MÃ¡s limpio
```

---

## ğŸ”„ Workflow Completo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TU PC (DESARROLLO)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… Migraciones actuales (con historial)                     â”‚
â”‚ âœ… Base de datos funcionando                                â”‚
â”‚ âš ï¸  NO modificar                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ git push
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    REPOSITORIO GIT                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ CÃ³digo fuente                                             â”‚
â”‚ â€¢ Migraciones de desarrollo (backup)                        â”‚
â”‚ â€¢ Scripts de producciÃ³n (generados)                         â”‚
â”‚ â€¢ DocumentaciÃ³n (DEPLOYMENT_BANCO.md)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ git clone
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SERVIDOR DEL BANCO (PRODUCCIÃ“N)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. Clonar repositorio                                       â”‚
â”‚ 2. Configurar cadenas de conexiÃ³n                           â”‚
â”‚ 3. Aplicar migraciones LIMPIAS (producciÃ³n)                â”‚
â”‚ 4. Compilar y publicar                                      â”‚
â”‚ 5. Configurar servicio                                      â”‚
â”‚ âœ… InstalaciÃ³n limpia completa                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Checklist de Pre-Deployment

Antes de ir al banco, asegÃºrate de:

- [ ] Generar migraciones limpias de producciÃ³n
- [ ] Revisar scripts SQL generados
- [ ] Probar scripts en ambiente de staging/desarrollo limpio
- [ ] Crear `DEPLOYMENT_BANCO.md` con instrucciones
- [ ] Preparar cadenas de conexiÃ³n del banco (sin passwords)
- [ ] Hacer backup de migraciones de desarrollo
- [ ] Commitear todo a Git
- [ ] Crear tag de versiÃ³n para el release
- [ ] Documentar cualquier configuraciÃ³n especial

---

## ğŸ“š Archivos de Referencia

1. **`DEPLOYMENT_BANCO.md`**: GuÃ­a completa de instalaciÃ³n en el banco
2. **`scripts/generate-production-migrations.ps1`**: Script PowerShell para generar migraciones
3. **`scripts/generate-production-migrations.sh`**: Script Bash para generar migraciones
4. **`scripts/production-migrations/`**: Carpeta con scripts SQL limpios

---

## â“ Preguntas Frecuentes

### Â¿Por quÃ© no puedo usar las migraciones de desarrollo?

**R:** Porque tienen historial de cambios que no son necesarios en una instalaciÃ³n limpia. Es como instalar Windows con todos los updates histÃ³ricos vs instalar la versiÃ³n final actualizada.

### Â¿QuÃ© pasa con mi base de datos de desarrollo?

**R:** NADA. Tu base de datos local sigue funcionando con las migraciones actuales. No toques nada en tu PC.

### Â¿Tengo que hacer esto cada vez que haga cambios?

**R:** No. Esta estrategia es SOLO para la instalaciÃ³n inicial en el banco. DespuÃ©s, usarÃ¡s migraciones normales para actualizaciones.

### Â¿Puedo aplicar las migraciones limpias en mi PC?

**R:** NO. Tu PC ya tiene las migraciones antiguas aplicadas. Aplicar las nuevas causarÃ­a conflictos. Las migraciones limpias son SOLO para instalaciones nuevas.

### Â¿QuÃ© hago si el banco pide actualizaciones despuÃ©s?

**R:** Para actualizaciones futuras, crearÃ¡s migraciones normales (no limpias) que se aplicarÃ¡n sobre la base instalada.

---

## ğŸš€ PrÃ³ximos Pasos

1. Lee `DEPLOYMENT_BANCO.md` completamente
2. Genera migraciones limpias usando los scripts
3. Revisa los scripts SQL generados
4. Prueba en un ambiente limpio local/staging
5. Coordina con el banco para la instalaciÃ³n
6. Sigue la guÃ­a paso a paso durante la instalaciÃ³n

---

## ğŸ“ Soporte

Si tienes dudas durante el proceso:
- Consulta `DEPLOYMENT_BANCO.md` para detalles
- Revisa esta guÃ­a para entender la estrategia
- Contacta al equipo tÃ©cnico del banco para aspectos de infraestructura
