using ManageAdmin.GraphQL.SDK;
using Microsoft.AspNetCore.Components;
using System.Text.Json;
using System.Text.RegularExpressions;
using ManageAdmin.Models;
using Task = System.Threading.Tasks.Task;
using Microsoft.JSInterop;


namespace ManageAdmin.FrontEnd.Pages
{
    public partial class ValidarWork
    {
        [Parameter] public required string Id { get; set; }
        [Parameter] public required string IdNotification { get; set; }

        [Parameter] public required string IdNotificationUser { get; set; }

        public IGetWorksById_WorksById Work { get; set; }
        public IReadOnlyList<IGetUsers_Users> Usuarios { get; set; }
        public List<IGetUsersByName_UsersByName> UsuariosSearch { get; set; } = new List<IGetUsersByName_UsersByName>();

        public IGetNotificationsById_NotificationsById Notification { get; set; }   

        public IGetAuthorizationRequestsFullByWorkId_AuthorizationRequestsFullByWorkId AuthorizationRequest { get; set; }

        public IGetNotificationUsersById_NotificationUsersById NotificationUser { get; set; }

        public string AuthorizationRequestState { get; set; }

        public Notifications_Json notifications_Json { get; set; }

        public String Lider { get; set; } = "";
        public String LiderName { get; set; } = "";
        public bool Gerente { get; set; }

        public bool isManager { get; set; }

        public class Notifications_Json
        {
            public string Notification_Type { get; set; }
            public bool Notification_Execute { get; set; }
        }

        
        protected override async Task OnInitializedAsync()
        {
            var result = await manageAdmin.GetWorksById.ExecuteAsync(Guid.Parse(Id));
            Work = result.Data.WorksById;

            var resultUsuarios = await manageAdmin.GetUsers.ExecuteAsync();
            Usuarios = resultUsuarios.Data.Users;

            Gerente = AppStateService.UserInformation.Roles.Contains("Gerente");

            isManager = AppStateService.UserInformation.Roles.Contains("Subdirector") || AppStateService.UserInformation.Roles.Contains("Director");

            var notificationUser = await manageAdmin.GetNotificationUsersById.ExecuteAsync(Guid.Parse(IdNotificationUser));
            var resultnotificationUser = notificationUser.Data.NotificationUsersById;
            NotificationUser = resultnotificationUser;


            var resultAuthorization = await manageAdmin.GetAuthorizationRequestsFullByWorkId.ExecuteAsync(Guid.Parse(Id));

            if(resultAuthorization.Data != null)
            {
                AuthorizationRequest = resultAuthorization.Data.AuthorizationRequestsFullByWorkId.FirstOrDefault();
                AuthorizationRequestState = AuthorizationRequest.StateEntities.State.State_name;
            }
            else
            {
                AuthorizationRequestState = "Pendiente";
            }



                var resultNotification = await manageAdmin.GetNotificationsById.ExecuteAsync(Guid.Parse(IdNotification));
            Notification = resultNotification.Data.NotificationsById;

            notifications_Json = JsonSerializer.Deserialize<Notifications_Json>(Notification.Notification_action_info);

            if (notifications_Json.Notification_Execute)
            {
               var resultWorkUserManager = await manageAdmin.GetworkUserManagersByWorkId.ExecuteAsync(Guid.Parse(Id));
                if(resultWorkUserManager.Data != null)
                {
                    Lider = resultWorkUserManager.Data.WorkUserManagersByWorkId.User.User_name;
                }
                

            }

            Task.Run(async () =>
            {
                await Task.Delay(500);
                await YooptaEditor.SetContentAsync(Work.Work_description, elementId: "yooptaeditor");
            });
        }


        private bool IsLoad { get; set; } = false;

        private async Task acceptProject()
        {


            if (!IsLoad)
            {
                if (Gerente == true)
                {
                    IsLoad = true;
                    if (String.IsNullOrEmpty(Lider))
                    {
                        ToastService.ShowError("Por favor seleccione un Líder Técnico", title: "Líder Técnico no seleccionado");
                        return;
                    }

                    var searchAutorizationRequest = await manageAdmin.GetAuthorizationRequestsByWorkId.ExecuteAsync(Guid.Parse(Id));
                    var autorizacionRequest = searchAutorizationRequest.Data.AuthorizationRequestsByWorkId;

                    if (await createAuthorization(autorizacionRequest) == true && await createUserManager() == true && await sendNotificationToUserManager() == true && await updateAuthorizationRequest(autorizacionRequest) == true)
                    {
                        await updateNotification();
                        navigationManager.NavigateTo("/notifications");
                    }

                }
                else
                {

                    IsLoad = true;
                    var searchAutorizationRequest = await manageAdmin.GetAuthorizationRequestsByWorkId.ExecuteAsync(Guid.Parse(Id));
                    var autorizacionRequest = searchAutorizationRequest.Data.AuthorizationRequestsByWorkId;


                    if (await createAuthorization(autorizacionRequest) == true && await updateAuthorizationRequest(autorizacionRequest) == true)
                    {
                        await updateNotification();
                        navigationManager.NavigateTo("/notifications");
                    }

                }
            }
        }


        private async Task rejectProject()
        {
            if (!IsLoad)
            {
                IsLoad = true;
                var searchStateEntitie = await manageAdmin.GetStateEntitiesByEntity.ExecuteAsync("Authorization");
                var searchStateEntitieData = searchStateEntitie.Data.StateEntitiesByEntity.FirstOrDefault(item => item.State.State_name == "Rechazado");

                var useridRechazo = await AppStateService.GetUserid(localStorage);

                //Actualizar la Autorizaction Request 

                Authorization_requestsInput authorization_RequestsInput = new Authorization_requestsInput
                {
                    Authorization_request_description = AuthorizationRequest.Authorization_request_description,
                    Authorization_request_id = AuthorizationRequest.Authorization_request_id,
                    Authorization_request_number = 0,
                    State_entity_id = searchStateEntitieData.State_entity_id,
                    User_id = useridRechazo,
                    Work_id = AuthorizationRequest.Work.Work_id,
                    Create_at = AuthorizationRequest.Create_at,
                    Modify_at = DateTimeOffset.Now

                };

                var updateAutorizationRequest = await manageAdmin.UpdateAuthorizationRequests.ExecuteAsync(authorization_RequestsInput);
                var data = updateAutorizationRequest.Data.UpdateAuthorizationRequests;

                //Actualizar todas las notificaciones de los usuarios que tenian que aceptar o rechazar el proyecto 

                var notificationUpdate = await manageAdmin.GetNotificationUserByNotificationId.ExecuteAsync(Guid.Parse(IdNotification));
                var notificationUpdateData = notificationUpdate.Data.NotificationUsersByNotificationId;

                foreach (var notification in notificationUpdateData)
                {
                    Notification_usersInput notification_ = new Notification_usersInput
                    {
                        Notification_id = notification.Notification.Notification_id,
                        Notification_user_seen = true,
                        Notification_user_id = notification.Notification_user_id,
                        User_id = notification.User.User_id,
                        Create_at = notification.Create_at,
                        Modify_at = DateTimeOffset.Now
                    };

                    var updateNotificationUser = await manageAdmin.UpdateNotificationUsers.ExecuteAsync(notification_);
                }


                if (data)
                {
                    navigationManager.NavigateTo("/notifications");
                }
            }

        }

        private async Task<bool> createAuthorization(IGetAuthorizationRequestsByWorkId_AuthorizationRequestsByWorkId authorizationRequests)
        {
            var userid = await AppStateService.GetUserid(localStorage);
            AuthorizationsInput authorizationsInput = new AuthorizationsInput
            {
                Authorization_id = Guid.NewGuid(),
                Authorization_request_id = authorizationRequests.Authorization_request_id,
                State_entity_id = authorizationRequests.State_entity_id,
                User_id = userid,
                Authorization_description = "Aceptada",
                Authorization_seen = true
            };

            var resultAuthorizations = await manageAdmin.InsertAuthorization.ExecuteAsync(authorizationsInput);

            return resultAuthorizations.Data.InsertAuthorization;
        }
        private async Task<bool> updateAuthorizationRequest(IGetAuthorizationRequestsByWorkId_AuthorizationRequestsByWorkId autorizacionRequest)
        {
            var estado = autorizacionRequest.State_entity_id;
            
            //Actualizar la Autorizaction Request 
            if (autorizacionRequest.Authorization_request_number - 1 == 0)
            {
                var result = await manageAdmin.GetEntitiesByName.ExecuteAsync("Authorization");
                var resultData = result.Data.EntitiesByName.FirstOrDefault();
                var stateEntitie = await manageAdmin.GetStateEntitiesByEntity.ExecuteAsync(resultData.Entity_name);
                var stateEntitieData = stateEntitie.Data.StateEntitiesByEntity.FirstOrDefault(c => c.State.State_name == "Aprobado");
                estado = stateEntitieData.State_entity_id;

            }

            Authorization_requestsInput authorization_RequestsInput = new Authorization_requestsInput
            {
                Authorization_request_description = autorizacionRequest.Authorization_request_description,
                Authorization_request_id = autorizacionRequest.Authorization_request_id,
                Authorization_request_number = autorizacionRequest.Authorization_request_number - 1,
                State_entity_id = estado,
                User_id = autorizacionRequest.User_id,
                Work_id = autorizacionRequest.Work_id,
                Create_at = autorizacionRequest.Create_at,
                Modify_at = DateTimeOffset.Now

            };

            var updateAutorizationRequest = await manageAdmin.UpdateAuthorizationRequests.ExecuteAsync(authorization_RequestsInput);
            return updateAutorizationRequest.Data.UpdateAuthorizationRequests;


        }
        private async Task<bool> updateNotification()
        {
            var notificacion = await manageAdmin.GetNotificationsById.ExecuteAsync(Guid.Parse(IdNotification));
            var notificacionData = notificacion.Data.NotificationsById;

            NotificationsInput notifications = new NotificationsInput
            {
                Notification_id = notificacionData.Notification_id,
                Notification_description = notificacionData.Notification_description,
                Notification_name = notificacionData.Notification_name,
                Notification_action = "Validar",
                Notification_action_info = JsonSerializer.Serialize(new
                {
                    Notification_Type = "Validar",
                    Notification_Execute = true
                }),
                Create_at = notificacionData.Create_at,
                Entity_id = notificacionData.Entity_id,
                Modify_at = DateTimeOffset.Now

            };

            var updateNotificacion = await manageAdmin.UpdateNotifications.ExecuteAsync(notifications);

            var notificationUser = await manageAdmin.GetNotificationUsersById.ExecuteAsync(Guid.Parse(IdNotificationUser));
            var notificationUserData = notificationUser.Data.NotificationUsersById;

            Notification_usersInput notification_update = new Notification_usersInput
            {
                Notification_id = notificationUserData.Notification_id,
                Notification_user_id = notificationUserData.Notification_user_id,
                Notification_user_seen = true,
                User_id = notificationUserData.User_id,
                Create_at = notificationUserData.Create_at,
                Modify_at = DateTimeOffset.Now
            };

            var updateNotificacion_Update = await manageAdmin.UpdateNotificationUsers.ExecuteAsync(notification_update);


            return updateNotificacion_Update.Data.UpdateNotificationUsers;
        }
        private async Task<bool> createUserManager()
        {
            var searchRol = await manageAdmin.GetUserRolssByUserID.ExecuteAsync(user_Id: Guid.Parse(Lider));
            var searchRolData = searchRol.Data.User_rol_By_IdUser.FirstOrDefault();


            work_user_managersInput lider_work = new work_user_managersInput
            {
                Work_user_manager_id = Guid.NewGuid(),
                Work_id = Guid.Parse(Id),
                User_id = Guid.Parse(Lider),
                User_rol_id = searchRolData.Rol_id,
                Create_at = DateTimeOffset.Now,
                Modify_at = DateTimeOffset.Now,
            };

            var insertWorkUserManager = await manageAdmin.InsertWorkUserManagers.ExecuteAsync(lider_work);

            return insertWorkUserManager.Data.InsertWorkUserManagers;
        }

        private async Task<bool> sendNotificationToUserManager()
        {

            //Crear la notificacion 
            var entitySearch = await manageAdmin.GetEntitiesByName.ExecuteAsync(entity_Name: "Authorization");
            var entityInfo = entitySearch.Data.EntitiesByName.FirstOrDefault();


            NotificationsInput notifications = new NotificationsInput
            {
                Notification_id = Guid.NewGuid(),
                Notification_name = "Asignado un nuevo proyecto",
                Notification_description = $"Se le ha asignado el proyecto de {Work.Work_name} ",
                Entity_id = (Guid)entityInfo.Entity_id,
                Notification_action = "Informativo",
                Notification_action_info = JsonSerializer.Serialize(new
                {
                    Notification_Type = "Informativo",
                    Notification_Execute = false
                }),
                Create_at = DateTimeOffset.Now,
                Modify_at = DateTimeOffset.Now,
            };

            var result = await manageAdmin.InsertNotifications.ExecuteAsync(notifications);
            var resultData = result.Data.InsertNotifications;

            if (!resultData) return false;

            // Crear la notificacion_user

            Notification_usersInput notification_ = new Notification_usersInput
            {

                Notification_user_id = Guid.NewGuid(),
                Notification_id = notifications.Notification_id,
                Notification_user_seen = false,
                User_id = Guid.Parse(Lider),
                Create_at = DateTimeOffset.Now,
                Modify_at = DateTimeOffset.Now,

            };

            var insertNotificacionUser = await manageAdmin.InsertNotificationUsers.ExecuteAsync(notification_);

            return insertNotificacionUser.Data.InsertNotificationUsers;
        }



        private bool IsModalVisible = false;
        public bool modalRender = false; 
        public ElementReference modal;

        protected override void OnAfterRender(bool firstRender)
        {
            if (IsModalVisible && !modalRender)
            {
                var x = DotNetObjectReference.Create(this);
                _ = jS.InvokeVoidAsync("registerClickOutsideHandler2.estaFuncion", modal, x);
                modalRender = true;
            }
        }

        [JSInvokable]
        public void HideModal()
        {
            IsModalVisible = false;
            modalRender = !modalRender;
            Dispose();
            StateHasChanged();
        }

        private void ShowModal()
        {
            IsModalVisible = !IsModalVisible;
        }


        private System.Timers.Timer debounceTimer;
        private string searchText;

        private void searchUsuario(ChangeEventArgs e)
        {
            searchText = e.Value.ToString();
            var regex = new Regex(@"^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+$");
            var isMatch = regex.IsMatch(searchText);
            var isString = string.IsNullOrEmpty(searchText);
            if (isMatch && !isString)
            {
                debounceTimer?.Stop();
                debounceTimer = new System.Timers.Timer(200);
                debounceTimer.Elapsed += async (_, __) =>
                {
                    debounceTimer.Stop();
                    await InvokeAsync(() => SearchInDataBase(searchText));
                    
                };

                debounceTimer.Start();
            }
            {
                UsuariosSearch.Clear();
            }

        }

        private async Task SearchInDataBase(string usuario)
        {
            var serach = await manageAdmin.GetUsersByName.ExecuteAsync(usuario);
            var serachdata = serach.Data.UsersByName;
            UsuariosSearch = (List<IGetUsersByName_UsersByName>)serachdata;
            StateHasChanged();
        }

        private void selectedLider(string guid, string name)
        {
            Lider = guid;
            LiderName = name;
            HideModal();
        }

        public void Dispose()
        {
            var x = DotNetObjectReference.Create(this);
            _ = jS.InvokeVoidAsync("registerClickOutsideHandler2.estaFuncionBorrar");
        }


    }
}
